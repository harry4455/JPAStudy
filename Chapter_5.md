# Chapter 5. 연관관계 매핑 기초

엔티티들은 대부분 다른 엔티티와 연관관계를 가짐.
객체는 참조(주소)를 사용하여 관계를 맺고, 테이블은 외래 키를 사용해서 관계를 맺음. -> 완전히 다른 특징

객체 관계 매핑 (ORM)에서 가장 어려운 부분이 "객체 연관관계와 테이블 연관관계를 매핑" 하는 것

* 방향(direction) : [단방향, 양방향]이 존재. 방향 관계는 객체 관계에만 존재하고, 테이블 관계는 항상 양방향
* 다중성(multiplicity) : [다대일, 일대다, 일대일, 다대다] 
* 연관관계의 주인(owner) : 객체를 양방향 연관관계로 만들면 연관관계의 주인을 정해야 함.

## 5.1 단방향 연관관계

<p align="center">
<img src="./imgs/JPA 연관관계 매핑.png" />
</p>

* 객체 연관관계 
  - 회원 객체는 Member.team 필드로 팀 객체와 연관관계를 맺음
  - 회원 객체와 팀 객체는 단방향 관계. 회원은 Member.team 필드를 통해 팀을 알 수 있지만, 팀은 그렇지 못함 
* 테이블 연관관계 
  - 회원 테이블은 TEAM_ID 외래 키로 팀 테이블과 연관관계를 맺음
  - 회원 테이블과 팀 테이블은 양방향 관계. 외래 키를 통해서 회원과 팀 / 팀과 회원을 조인할 수 있음  
  
<br>

<b>※ 객체 연관관계와 테이블 연관관계의 가장 큰 차이점</b>  
참조를 통한 연관관계를 단방향이기에, 반대의 관계를 갖긴 위해선 필드를 추가해서 참조를 보관해야함
서로 참조하는 양방향 관계처럼 보이지만, 사실상 서로 다른 단방향 관계 2개임.


### 5.1.1 순수한 객체 연관관계

객체는 참조를 사용해서 연관관계를 탐색할 수 있음 -> 객체 그래프 탐색

### 5.1.2 테이블 연관관계

데이터베이스는 외래 키를 사용해서 연관관계를 탐색할 수 있음 -> 조인(JOIN)

### 5.1.3 객체 관계 매핑

JPA를 사용하여 객체만 사용한 연관관계와 테이블만 사용한 연관관계를 매핑

@ManyToOne : 다대일 관계라는 매핑 정보. 연관관계를 매핑할 때 다중성을 나타내는 어노테이션을 피루소 사용해야 함.  
@JoinColumn(name="") : 조인 컬럼은 외래 키를 매핑할 때 사용. name 속성에는 매핑할 외래 키 이름을 지정.해당 어노테이션은 생략 가능

### 5.1.4 @JoinColumn

외래 키를 매핑할 때 사용

|속성|기능|기본값|
|:---|:---|:---|
|name|매핑할 외래 키 이름|빌드 + _ + 참조하는 테이블의 기본 키 컬럼명|
|referencedColumnName|외래 키가 참조하는 대상 테이블의 컬럼명|참조하는 테이블의 기본 키 컬럼명|
|foreignKey(DDL)|외래 키 제약조건을 직접 지정할 수 있음. 이 속성은 테이블을 생성할때만 사용||
|unique<br> nullable<br> insertable<br> updatable<br> columnDeifinition<br> table|@Column의 속성과 같음||

### 5.1.5 @ManyToOne

다대일 관계에서 사용

|속성|기능|기본값|
|:---|:---|:---|
|optional|false로 설정하면 연관된 엔티티가 항상 있어야 함.|true|
|fetch|글로벌 패치 전략을 설정|*@ManyToOne = FetchType.EAGER <br> *@OneToMany = FetchType.LAZY|
|cascade|영속성 전이 기능을 사용||
|targetEntity|연관된 엔티티의 타입 정보를 설정. 거의 사용하지 않는 기능. 컬렉션을 사용해도 제네릭으로 타입 정보를 알 수 있음.||

## 5.2 연관관계 사용

### 5.2.1 저장

값들을 set하고 em.persist() 통해서 DB에 저장

### 5.2.2. 조회

조회 방법은 크게 2가지
1. 객체 그래프 탐색(객체 연관관계를 사용한 조회)
ex) member.getTeam()을 사용해서 member와 연관된 team 엔티티를 조회할 수 있음
 
2. 객체지향 쿼리 사용 (JPQL)
ex) 팀1에 소속된 회원만 조회하려는 경우 -> join절을 활용
t.name =: teamName -> :로 시작되는 것은 파라미터를 바인딩받는 문법

### 5.2.3 수정

em.update()와 같은 메소드는 없다
단순히 불러온 엔티티의 값을 변경해두면 트랜잭션을 커밋할 때 플러시가 일어나면서 변경 감지 기능이 작동함.
이후 변경사항을 DB에 자동으로 반영. 연관관계를 수정할 때에도 동일.

### 5.2.4 연관관계 제거

em.find() 이후 null 처리로 제거.
SQL로 치면 null로 UPDATE

### 5.2.5 연관된 엔티티 삭제 

연관된 엔티티를 삭제하려면 기존에 있던 연관관계를 먼저 제거하고 삭제해야함.
아니면 외래 키 제약조건으로 DB에서 오류가 발생.

## 5.3 양방향 연관관계